---
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';
import { PenTool, Image as ImageIcon, Send, X } from 'lucide-react';
import '../../styles/global.css';
---

<html lang="id">
<head>
    <title>Tulis Artikel | Redaksi</title>
</head>
<body>
    <Navbar />

    <main class="container" style="max-width: 800px; padding-top: 40px; padding-bottom: 60px;">
        
        <header class="page-header">
            <h1 class="page-title"><PenTool className="icon-title" /> Editorial Workspace</h1>
            <p class="page-subtitle">Pastikan berita valid, tajam, dan berimbang sebelum dikirim.</p>
        </header>

        <form id="news-form" class="editor-form">
            
            <div class="form-group">
                <label for="title">Headline Berita</label>
                <input type="text" id="title" class="input-field title-input" placeholder="Ketik judul yang menarik..." required>
            </div>

            <div class="form-group">
                <label>Gambar Sampul</label>
                
                <div id="preview-container" class="preview-box hidden">
                    <img id="img-preview" src="" alt="Preview" />
                    <button type="button" id="btn-remove-img" class="btn-remove"><X size={16} /> Hapus</button>
                </div>

                <div id="upload-box" class="file-upload-wrapper">
                    <input type="file" id="cover_image" accept="image/*" class="file-input">
                    <div class="file-custom-btn">
                        <ImageIcon size={24} /> 
                        <div style="text-align: left;">
                            <span style="font-weight: 600; display: block;">Klik untuk upload gambar</span>
                            <span style="font-size: 0.8rem; color: #888;">Format JPG/PNG. Max 2MB.</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="content">Isi Berita</label>
                <textarea id="content" class="input-field content-area" rows="20" placeholder="Mulai menulis cerita di sini..." required></textarea>
                <small>Tips: Gunakan tag HTML sederhana seperti &lt;p&gt;, &lt;b&gt;, atau &lt;h2&gt; untuk format.</small>
            </div>

            <div class="form-actions">
                <button type="submit" id="btn-submit" class="btn btn-primary">
                    <Send size={18} /> Kirim ke Meja Redaksi
                </button>
                <p id="status-msg" class="status-text"></p>
            </div>

        </form>

    </main>
    
    <Footer />

    <script>
        import { supabase } from '../../lib/supabase';

        // Elements
        const form = document.getElementById('news-form');
        const titleInput = document.getElementById('title') as HTMLInputElement;
        const contentInput = document.getElementById('content') as HTMLTextAreaElement;
        const imageInput = document.getElementById('cover_image') as HTMLInputElement;
        const btnSubmit = document.getElementById('btn-submit') as HTMLButtonElement;
        const statusMsg = document.getElementById('status-msg');
        
        // Preview Elements
        const previewContainer = document.getElementById('preview-container');
        const imgPreview = document.getElementById('img-preview') as HTMLImageElement;
        const btnRemoveImg = document.getElementById('btn-remove-img');
        const uploadBox = document.getElementById('upload-box');

        // 1. LOGIC PREVIEW GAMBAR
        imageInput?.addEventListener('change', function() {
            const file = this.files?.[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (imgPreview && e.target?.result) {
                        imgPreview.src = e.target.result as string;
                        previewContainer?.classList.remove('hidden');
                        uploadBox?.classList.add('hidden'); // Sembunyikan tombol upload biar rapi
                    }
                }
                reader.readAsDataURL(file);
            }
        });

        // Tombol Hapus/Ganti Gambar
        btnRemoveImg?.addEventListener('click', () => {
            imageInput.value = ''; // Reset input
            previewContainer?.classList.add('hidden');
            uploadBox?.classList.remove('hidden');
        });

        // 2. LOGIC SUBMIT (Sama seperti sebelumnya)
        form?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!btnSubmit || !statusMsg) return;

            // Validasi manual karena input file hidden
            if (!imageInput.files?.length) {
                alert("Mohon pilih gambar sampul!");
                return;
            }

            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '‚è≥ Mengupload...';
            
            try {
                const file = imageInput.files[0];
                const fileName = `${Date.now()}-${file.name.replace(/\s/g, '-')}`;
                
                const { error: uploadError } = await supabase.storage.from('news-images').upload(fileName, file);
                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabase.storage.from('news-images').getPublicUrl(fileName);
                const { data: { user } } = await supabase.auth.getUser();

                const slug = titleInput.value.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-') + '-' + Date.now();

                const { error: dbError } = await supabase.from('articles').insert({
                    title: titleInput.value,
                    slug: slug,
                    content: contentInput.value,
                    cover_url: publicUrl,
                    author_id: user?.id,
                    status: 'pending'
                });

                if (dbError) throw dbError;

                alert("Berita Berhasil Terkirim!");
                window.location.href = '/';

            } catch (err: any) {
                alert("Error: " + err.message);
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = 'Kirim Ulang';
            }
        });
    </script>
</body>
</html>

<style>
    /* Styling Global Form */
    .page-header { margin-bottom: 40px; border-bottom: 2px solid var(--fg); padding-bottom: 20px; }
    .page-title { font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 2rem; display: flex; align-items: center; gap: 10px; }
    
    .editor-form { display: flex; flex-direction: column; gap: 30px; }
    .form-group label { display: block; font-family: 'Poppins', sans-serif; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; letter-spacing: 0.5px; }

    /* TEXT AREA - POPPINS MEDIUM BOLD */
    .input-field {
        width: 100%;
        padding: 15px;
        border: 2px solid #ddd; /* Border lebih tebal dikit */
        background: #fff;
        font-family: 'Poppins', sans-serif; /* REQ USER */
        font-weight: 500; /* MEDIUM BOLD */
        font-size: 1rem;
        outline: none;
        transition: all 0.2s;
        border-radius: 8px;
    }
    .input-field:focus { border-color: var(--fg); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

    .title-input { font-size: 1.2rem; font-weight: 600; }
    .content-area { line-height: 1.8; color: #333; }

    /* UPLOAD & PREVIEW STYLING */
    .file-upload-wrapper { position: relative; overflow: hidden; cursor: pointer; }
    .file-input { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
    
    .file-custom-btn {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        background: #fafafa;
        color: #555;
        transition: background 0.2s;
    }
    .file-upload-wrapper:hover .file-custom-btn { background: #f0f0f0; border-color: #999; }

    .hidden { display: none !important; }

    .preview-box { position: relative; width: 100%; max-width: 400px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .preview-box img { width: 100%; display: block; }
    .btn-remove {
        position: absolute; top: 10px; right: 10px;
        background: rgba(0,0,0,0.7); color: white; border: none;
        padding: 5px 10px; border-radius: 4px; cursor: pointer;
        display: flex; align-items: center; gap: 5px; font-size: 0.8rem;
    }
    .btn-remove:hover { background: red; }

    /* BUTTON */
    .btn-primary {
        background: var(--fg); color: var(--bg); border: none;
        padding: 15px 30px; font-size: 1rem; font-weight: 600;
        display: inline-flex; align-items: center; gap: 10px;
        cursor: pointer; border-radius: 8px;
        font-family: 'Poppins', sans-serif;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
</style>