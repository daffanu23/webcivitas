---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';
// Import Komponen Navigasi Kategori yang baru kita buat
import CategoryNav from '../components/CategoryNav.astro';
// SESUAIKAN IMPORT INI DENGAN NAMA FILE KARTU ANDA (Misal: NewsCard.astro / SubNews.astro)
import SubNewsCard from '../components/SubNewsCard.astro';

// 1. Cek apakah ada filter kategori di URL (Contoh: /arsip?kategori=sport)
const activeCategory = Astro.url.searchParams.get('kategori');

let articles = [];
let categoryName = "Semua Berita";

// 2. Logika Filter Database
if (activeCategory) {
    // A. Cari ID Kategori berdasarkan slug
    const { data: cat } = await supabase.from('categories').select('id, name').eq('slug', activeCategory).single();
    
    if (cat) {
        categoryName = `Kategori: ${cat.name}`;
        // B. Cari ID Artikel yang punya Kategori tersebut di Tabel Pivot
        const { data: pivot } = await supabase.from('article_categories').select('article_id').eq('category_id', cat.id);
        
        if (pivot && pivot.length > 0) {
            const articleIds = pivot.map(p => p.article_id);
            // C. Ambil artikelnya
            const { data } = await supabase
                .from('articles')
                .select('*, profiles(full_name)')
                .eq('status', 'published')
                .in('id', articleIds)
                .order('created_at', { ascending: false });
            articles = data || [];
        }
    }
} else {
    // D. Jika tidak ada filter, ambil SEMUA berita
    const { data } = await supabase
        .from('articles')
        .select('*, profiles(full_name)')
        .eq('status', 'published')
        .order('created_at', { ascending: false });
    articles = data || [];
}
---

<Layout title="Arsip Berita | MEDIACIVITAS">
    <div class="archive-container">
        
        <header class="archive-header">
            <h1 class="page-title">{categoryName}</h1>
            <p class="article-count">Total {articles.length} artikel diterbitkan.</p>
        </header>

        {/* COMPONENT KATEGORI KITA PASANG DI SINI! */}
        <CategoryNav activeSlug={activeCategory} />

        {articles.length === 0 ? (
            <div class="empty-state">
                <p>Belum ada berita di kategori ini.</p>
            </div>
        ) : (
            <div class="news-grid">
                {articles.map((article) => (
                    <SubNewsCard article={article} />
                ))}
            </div>
        )}

    </div>
</Layout>

<style>
    .archive-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px 100px 20px;
    }
    .archive-header {
        margin-bottom: 30px;
        border-bottom: 1px solid var(--border-muted);
        padding-bottom: 20px;
    }
    .page-title {
        font-family: 'Poppins', sans-serif;
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 10px;
    }
    .article-count {
        color: var(--text-muted);
        font-size: 1rem;
    }
    .news-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 30px;
        margin-top: 20px;
    }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
        border: 1px dashed var(--border);
        border-radius: 12px;
        margin-top: 20px;
    }
</style>