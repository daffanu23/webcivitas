---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';
import { Calendar, User, Share2, Bookmark, Clock } from 'lucide-react';
// IMPORT PENERJEMAH MARKDOWN
import { marked } from 'marked';

const { slug } = Astro.params;
if (!slug) return Astro.redirect('/404');

const { data: article, error } = await supabase.from('articles').select(`*, profiles ( full_name )`).eq('slug', slug).single();
if (error || !article) return Astro.redirect('/404');

const authorName = article.profiles?.full_name || 'Redaksi';
const publishDate = new Date(article.created_at).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
const words = article.content ? article.content.split(/\s+/).length : 0;
const readTime = Math.ceil(words / 200);

// SULAP: UBAH MARKDOWN JADI HTML BERSIH DI SERVER
const htmlContent = marked.parse(article.content || 'Konten tidak tersedia.');
---

<Layout title={`${article.title} | MEDIACIVITAS`}>

    <article class="article-wrapper">
        <header class="header-section">
            <h1 class="main-headline">{article.title}</h1>
            <div class="meta-row">
                <div class="meta-pill"><User size={14} /> <span>{authorName}</span></div>
                <div class="meta-pill"><Calendar size={14} /> <span>{publishDate}</span></div>
                <div class="meta-pill"><Clock size={14} /> <span>{readTime} menit baca</span></div>
            </div>
        </header>

        {article.cover_url && (
            <div class="featured-image">
                <img src={article.cover_url} alt={article.title} transition:name={`hero-${slug}`} />
            </div>
        )}

        {/* RENDER HTML BERSIH DARI MARKDOWN */}
        <div class="article-content" set:html={htmlContent}></div>

        <div class="footer-actions">
            <button class="action-btn" id="share-btn" data-url={Astro.url.href}><Share2 size={18} /> <span>Bagikan</span></button>
            <button class="action-btn" id="bookmark-btn" data-id={article.id}><Bookmark size={18} className="icon-bookmark" /> <span id="bookmark-text">Simpan</span></button>
        </div>
    </article>

</Layout>

<script>
    import { supabase } from '../../lib/supabase';
    document.addEventListener('astro:page-load', async () => {
        const btnShare = document.getElementById('share-btn');
        if (btnShare) {
            btnShare.addEventListener('click', () => {
                const url = btnShare.getAttribute('data-url');
                if (url) {
                    navigator.clipboard.writeText(url).then(() => {
                        const originalHTML = btnShare.innerHTML;
                        btnShare.innerHTML = `<span>Disalin!</span>`;
                        setTimeout(() => btnShare.innerHTML = originalHTML, 2000);
                    });
                }
            });
        }
        const btnBookmark = document.getElementById('bookmark-btn');
        const iconBookmark = document.querySelector('.icon-bookmark');
        const textBookmark = document.getElementById('bookmark-text');
        if (btnBookmark && iconBookmark) {
            const articleId = btnBookmark.getAttribute('data-id');
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                const { data } = await supabase.from('bookmarks').select('id').eq('user_id', session.user.id).eq('article_id', articleId).single();
                if (data) {
                    btnBookmark.classList.add('saved'); iconBookmark.setAttribute('fill', 'currentColor'); if(textBookmark) textBookmark.innerText = "Tersimpan";
                }
            }
            btnBookmark.addEventListener('click', async () => {
                if (!session) return window.location.href = '/login';
                const isSaved = btnBookmark.classList.contains('saved');
                if (isSaved) {
                    const { error } = await supabase.from('bookmarks').delete().eq('user_id', session.user.id).eq('article_id', articleId);
                    if (!error) { btnBookmark.classList.remove('saved'); iconBookmark.setAttribute('fill', 'none'); if(textBookmark) textBookmark.innerText = "Simpan"; }
                } else {
                    const { error } = await supabase.from('bookmarks').insert({ user_id: session.user.id, article_id: articleId });
                    if (!error) { btnBookmark.classList.add('saved'); iconBookmark.setAttribute('fill', 'currentColor'); if(textBookmark) textBookmark.innerText = "Tersimpan"; }
                }
            });
        }
    });
</script>

<style>
    .article-wrapper {
        width: 100%; max-width: 800px; margin: 0 auto;
        padding: 40px 20px 100px 20px; box-sizing: border-box;
    }

    .header-section { text-align: center; margin-bottom: 40px; }
    .main-headline { font-family: 'Poppins', sans-serif; font-size: 2.2rem; font-weight: 700; line-height: 1.3; color: var(--text); margin-bottom: 20px; word-break: normal; overflow-wrap: break-word; }
    .meta-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .meta-pill { display: flex; align-items: center; gap: 6px; background: var(--bg-light); border: 1px solid var(--border-muted); padding: 6px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }

    .featured-image { width: 100%; margin-bottom: 40px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-muted); }
    .featured-image img { width: 100%; height: auto; display: block; }

    /* CSS UNTUK KONTEN (TIDAK ADA LAGI CAMPUR TANGAN EDITOR HTML) */
    .article-content {
        font-family: 'Poppins', sans-serif;
        font-size: 1.05rem; 
        line-height: 1.8;   
        color: var(--text);
        
        /* STANDAR PDF UNTUK MENCEGAH TEKS TERPOTONG & LAYOUT HANCUR */
        word-break: normal !important;      
        overflow-wrap: break-word !important; 
        white-space: normal !important;     
        hyphens: none !important;           
        text-align: left;
    }

    /* KARENA MARKDOWN MENGHASILKAN HTML MURNI, KITA BISA STYLE DENGAN MUDAH */
    .article-content :global(p) { margin-top: 0; margin-bottom: 1.5em; display: block; }
    
    .article-content :global(h1), 
    .article-content :global(h2), 
    .article-content :global(h3) { 
        font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em; line-height: 1.3; 
        color: var(--text);
    }
    
    .article-content :global(ul), .article-content :global(ol) { margin-bottom: 1.5em; padding-left: 20px; }
    .article-content :global(li) { margin-bottom: 0.5em; }
    
    .article-content :global(blockquote) { 
        border-left: 4px solid var(--text); padding: 15px 20px; font-style: italic; 
        color: var(--text-muted); margin: 25px 0; background: var(--bg-light); border-radius: 4px; 
    }
    
    .article-content :global(img) { max-width: 100%; height: auto; border-radius: 8px; margin: 25px 0; display: block; }
    .article-content :global(a) { color: var(--text); text-decoration: underline; font-weight: 600; }

    .footer-actions { margin-top: 60px; padding-top: 30px; border-top: 1px solid var(--border-muted); display: flex; justify-content: center; gap: 15px; }
    .action-btn { background: transparent; border: 1px solid var(--border); padding: 10px 20px; border-radius: 50px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; color: var(--text); transition: all 0.2s; }
    .action-btn:hover { background: var(--text); color: var(--bg); border-color: var(--text); }
    .action-btn.saved { background: var(--text); color: var(--bg); border-color: var(--text); }
    
    @media (max-width: 600px) { .article-wrapper { padding-left: 10px; padding-right: 10px; } }
</style>