---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';
import { Calendar, User, Share2, Bookmark } from 'lucide-react';

const { slug } = Astro.params;

// 1. VALIDASI
if (!slug) return Astro.redirect('/404');

// 2. QUERY ARTIKEL
const { data: article, error } = await supabase
  .from('articles')
  .select(`*, profiles ( full_name )`)
  .eq('slug', slug)
  .single();

if (error || !article) return Astro.redirect('/404');

// 3. HELPER
const authorName = article.profiles?.full_name || 'Redaksi';
const publishDate = new Date(article.created_at).toLocaleDateString('id-ID', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
});
---

<Layout title={`${article.title} | MEDIACIVITAS`}>

    <article class="article-container">
        
        <header class="article-header">
            <h1 class="title">{article.title}</h1>
            <div class="meta-wrapper">
                <div class="meta-item">
                    <User size={18} />
                    <span class="meta-text">{authorName}</span>
                </div>
                <div class="meta-divider"></div>
                <div class="meta-item">
                    <Calendar size={18} />
                    <span class="meta-text">{publishDate}</span>
                </div>
            </div>
        </header>

        {article.cover_url && (
            <div class="hero-image-wrapper">
                <img src={article.cover_url} alt={article.title} class="hero-image" transition:name={`hero-${slug}`} />
            </div>
        )}

        <div class="content-body">
            <Fragment set:html={article.content} />
        </div>

        <div class="article-footer">
            
            <button class="btn-action" id="share-btn" data-url={Astro.url.href}>
                <Share2 size={18} />
                <span>Bagikan</span>
            </button>

            <button class="btn-action" id="bookmark-btn" data-id={article.id}>
                <Bookmark size={18} className="icon-bookmark" />
                <span id="bookmark-text">Simpan</span>
            </button>

        </div>

    </article>

</Layout>

<script>
    import { supabase } from '../../lib/supabase';

    // LOGIC COPY LINK
    document.addEventListener('astro:page-load', async () => {
        // --- 1. SHARE ---
        const btnShare = document.getElementById('share-btn');
        if (btnShare) {
            btnShare.addEventListener('click', () => {
                const url = btnShare.getAttribute('data-url');
                if (url) {
                    navigator.clipboard.writeText(url).then(() => {
                        const originalHTML = btnShare.innerHTML;
                        btnShare.innerHTML = `<span style='font-size:0.9rem'>Disalin!</span>`;
                        setTimeout(() => btnShare.innerHTML = originalHTML, 2000);
                    });
                }
            });
        }

        // --- 2. BOOKMARK ---
        const btnBookmark = document.getElementById('bookmark-btn');
        const iconBookmark = document.querySelector('.icon-bookmark');
        const textBookmark = document.getElementById('bookmark-text');

        if (btnBookmark && iconBookmark) {
            const articleId = btnBookmark.getAttribute('data-id');
            const { data: { session } } = await supabase.auth.getSession();

            // A. CEK STATUS AWAL (Apakah sudah dibookmark?)
            if (session) {
                const { data } = await supabase
                    .from('bookmarks')
                    .select('id')
                    .eq('user_id', session.user.id)
                    .eq('article_id', articleId)
                    .single();
                
                if (data) {
                    // Sudah tersimpan: Ubah tampilan jadi solid
                    btnBookmark.classList.add('active');
                    iconBookmark.setAttribute('fill', 'currentColor');
                    if(textBookmark) textBookmark.innerText = "Tersimpan";
                }
            }

            // B. KLIK TOMBOL
            btnBookmark.addEventListener('click', async () => {
                if (!session) {
                    alert('Silakan login untuk menyimpan berita!');
                    window.location.href = '/login';
                    return;
                }

                // Cek apakah sedang aktif (tersimpan)
                const isActive = btnBookmark.classList.contains('active');

                if (isActive) {
                    // HAPUS BOOKMARK
                    const { error } = await supabase
                        .from('bookmarks')
                        .delete()
                        .eq('user_id', session.user.id)
                        .eq('article_id', articleId);
                    
                    if (!error) {
                        btnBookmark.classList.remove('active');
                        iconBookmark.setAttribute('fill', 'none');
                        if(textBookmark) textBookmark.innerText = "Simpan";
                    }
                } else {
                    // TAMBAH BOOKMARK
                    const { error } = await supabase
                        .from('bookmarks')
                        .insert({ user_id: session.user.id, article_id: articleId });
                    
                    if (!error) {
                        btnBookmark.classList.add('active');
                        iconBookmark.setAttribute('fill', 'currentColor');
                        if(textBookmark) textBookmark.innerText = "Tersimpan";
                    }
                }
            });
        }
    });
</script>

<style>
    /* CONTAINER */
    .article-container {
        max-width: 800px; margin: 0 auto; padding: 40px 20px 120px 20px;
    }

    /* HEADER */
    .article-header { text-align: center; margin-bottom: 40px; }
    .title {
        font-family: 'Poppins', sans-serif; font-size: 2.5rem; font-weight: 600;
        line-height: 1.2; margin-bottom: 25px; letter-spacing: -1px; color: var(--text);
    }

    /* META */
    .meta-wrapper {
        display: flex; justify-content: center; align-items: center; gap: 20px; padding: 15px 0;
        border-top: 1px solid var(--border-muted); border-bottom: 1px solid var(--border-muted);
    }
    .meta-item { display: flex; align-items: center; gap: 8px; color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
    .meta-divider { width: 1px; height: 20px; background: var(--border-muted); }

    /* IMAGE */
    .hero-image-wrapper {
        width: 100%; margin-bottom: 50px; border-radius: 16px; overflow: hidden;
        border: 1px solid var(--border-muted);
    }
    .hero-image { width: 100%; height: auto; display: block; }

    /* CONTENT */
    .content-body {
        font-family: 'Poppins', sans-serif; font-size: 1.125rem; line-height: 1.8; color: var(--text); font-weight: 400;
    }
    .content-body :global(p) { margin-bottom: 1.5em; }
    .content-body :global(h2), .content-body :global(h3) { 
        font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em; color: var(--text);
    }
    .content-body :global(h2) { font-size: 1.8rem; } .content-body :global(h3) { font-size: 1.4rem; }
    .content-body :global(ul), .content-body :global(ol) { margin-bottom: 1.5em; padding-left: 20px; }
    .content-body :global(blockquote) {
        border-left: 4px solid var(--text); padding: 20px; font-style: italic; font-size: 1.2rem;
        color: var(--text-muted); margin: 30px 0; background: var(--bg-light); border-radius: 0 8px 8px 0;
    }
    .content-body :global(img) { max-width: 100%; height: auto; border-radius: 8px; margin: 30px 0; }

    /* FOOTER (BUTTONS) */
    .article-footer {
        margin-top: 60px; padding-top: 30px; border-top: 1px solid var(--border-muted);
        display: flex; justify-content: space-between; align-items: center; gap: 15px;
    }

    /* GENERAL BUTTON STYLE */
    .btn-action {
        display: flex; align-items: center; gap: 8px;
        background: var(--bg-light); border: 1px solid var(--border-muted); color: var(--text);
        padding: 10px 20px; border-radius: 50px; cursor: pointer;
        font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 0.9rem;
        transition: all 0.2s;
    }
    .btn-action:hover {
        background: var(--text); color: var(--bg); border-color: var(--text);
    }

    /* ACTIVE STATE (BOOKMARK TERSIMPAN) */
    .btn-action.active {
        background: var(--text); color: var(--bg); border-color: var(--text);
    }

    @media (max-width: 768px) {
        .title { font-size: 1.8rem; }
        .article-container { padding-left: 20px; padding-right: 20px; }
        .article-footer { justify-content: center; }
    }
</style>