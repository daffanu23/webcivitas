---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';
import { Calendar, User, Share2 } from 'lucide-react';

const { slug } = Astro.params;

// 1. VALIDASI SLUG
if (!slug) {
  return Astro.redirect('/404');
}

// 2. QUERY DATABASE
const { data: article, error } = await supabase
  .from('articles')
  .select(`
    *,
    profiles ( full_name, role, avatar_url )
  `)
  .eq('slug', slug)
  .single();

// 3. HANDLE 404
if (error || !article) {
  return Astro.redirect('/404');
}

// Helper user
const author = Array.isArray(article.profiles) ? article.profiles[0] : article.profiles;
const authorName = author?.full_name || 'Redaksi';
const publishDate = new Date(article.created_at).toLocaleDateString('id-ID', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
});
---

<Layout title={`${article.title} | MEDIACIVITAS`}>

    <article class="article-container">
        
        <header class="article-header">
            <h1 class="title">{article.title}</h1>
            
            <div class="meta-wrapper">
                <div class="meta-item">
                    <User size={18} />
                    <span class="meta-text">{authorName}</span>
                </div>
                <div class="meta-divider"></div>
                <div class="meta-item">
                    <Calendar size={18} />
                    <span class="meta-text">{publishDate}</span>
                </div>
            </div>
        </header>

        {article.cover_url && (
            <div class="hero-image-wrapper">
                <img 
                    src={article.cover_url} 
                    alt={article.title} 
                    class="hero-image"
                    transition:name={`hero-${slug}`} 
                />
            </div>
        )}

        <div class="content-body">
            <Fragment set:html={article.content} />
        </div>

        <div class="article-footer">
            <span class="share-label">Bagikan artikel ini:</span>
            
            <button class="btn-share" id="share-btn" data-url={Astro.url.href}>
                <Share2 size={18} />
                <span>Copy Link</span>
            </button>
        </div>

    </article>

</Layout>

<script>
    document.addEventListener('astro:page-load', () => {
        const btn = document.getElementById('share-btn');
        if (btn) {
            btn.addEventListener('click', () => {
                const url = btn.getAttribute('data-url'); 
                if (url) {
                    navigator.clipboard.writeText(url).then(() => {
                        const originalText = btn.innerHTML;
                        btn.innerHTML = `<span>Copied!</span>`;
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                        }, 2000);
                    });
                }
            });
        }
    });
</script>

<style>
    /* CONTAINER KHUSUS BACA */
    .article-container {
        max-width: 800px;
        margin: 0 auto;
        padding-top: 40px;
        padding-bottom: 120px;
    }

    /* HEADER */
    .article-header { text-align: center; margin-bottom: 40px; }
    
    .title {
        font-family: 'Poppins', sans-serif;
        font-size: 2.5rem;
        font-weight: 600;
        line-height: 1.2;
        margin-bottom: 25px;
        letter-spacing: -1px;
        
        /* GANTI: Warna text utama */
        color: var(--text);
    }

    /* META DATA */
    .meta-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        padding: 15px 0;
        
        /* GANTI: Border variabel */
        border-top: 1px solid var(--border-muted);
        border-bottom: 1px solid var(--border-muted);
    }

    .meta-item { 
        display: flex; align-items: center; gap: 8px; 
        
        /* GANTI: Warna text muted */
        color: var(--text-muted); 
        font-size: 0.9rem; font-weight: 500;
    }
    
    .meta-divider { 
        width: 1px; height: 20px; 
        /* GANTI: Warna divider */
        background: var(--border-muted); 
    }

    /* GAMBAR HERO */
    .hero-image-wrapper {
        width: 100%;
        margin-bottom: 50px;
        border-radius: 16px;
        overflow: hidden;
        /* GANTI: Border variabel */
        border: 1px solid var(--border-muted);
    }
    .hero-image {
        width: 100%; height: auto; display: block;
    }

    /* ISI KONTEN */
    .content-body {
        font-family: 'Poppins', sans-serif;
        font-size: 1.125rem;
        line-height: 1.8;
        
        /* GANTI: Warna text isi konten */
        color: var(--text);
        
        font-weight: 400;
    }

    .content-body :global(p) { margin-bottom: 1.5em; }
    
    .content-body :global(h2) { 
        font-size: 1.8rem; font-weight: 700; margin-top: 2em; margin-bottom: 0.5em; 
        /* GANTI: Warna Heading */
        color: var(--text);
    }
    
    .content-body :global(h3) { 
        font-size: 1.4rem; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em; 
        /* GANTI: Warna Heading */
        color: var(--text);
    }
    
    .content-body :global(ul), .content-body :global(ol) { 
        margin-bottom: 1.5em; padding-left: 20px; 
    }
    
    /* BLOCKQUOTE (Kutipan) */
    .content-body :global(blockquote) {
        /* GANTI: Border samping */
        border-left: 4px solid var(--text);
        
        padding-left: 20px;
        font-style: italic;
        font-size: 1.2rem;
        
        /* GANTI: Warna text blockquote */
        color: var(--text-muted);
        
        margin: 30px 0;
        
        /* GANTI: Background blockquote (biar ga silau di dark mode) */
        background: var(--bg-light);
        
        padding: 20px;
        border-radius: 0 8px 8px 0;
    }
    
    .content-body :global(img) {
        max-width: 100%; height: auto; border-radius: 8px; margin: 30px 0;
    }

    /* FOOTER ARTIKEL */
    .article-footer {
        margin-top: 60px;
        padding-top: 30px;
        /* GANTI: Border atas */
        border-top: 1px solid var(--border-muted);
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .share-label { 
        font-weight: 600; font-size: 0.9rem; 
        /* GANTI: Warna label share */
        color: var(--text-muted); 
    }

    /* TOMBOL SHARE */
    .btn-share {
        display: flex; align-items: center; gap: 8px;
        
        /* GANTI: Background tombol & Border */
        background: var(--bg-light); 
        border: 1px solid var(--border-muted);
        color: var(--text);
        
        padding: 8px 16px; border-radius: 50px;
        cursor: pointer; font-family: 'Poppins', sans-serif;
        font-weight: 600; font-size: 0.9rem;
        transition: all 0.2s;
    }
    
    .btn-share:hover {
        /* GANTI: Invert saat hover */
        background: var(--text); 
        color: var(--bg); 
        border-color: var(--text);
    }

    @media (max-width: 768px) {
        .title { font-size: 1.8rem; }
        .article-container { padding-left: 20px; padding-right: 20px; }
    }
</style>